<script>
(function () {
  const DEFAULT_VER = {{ printf "%q" .Site.Params.default_version }};

  // Try multiple data shapes/locations
  const RAW_A = {{ site.Data.versions | jsonify }};                 // data/versions.(yml|yaml|json)
  const RAW_B = {{ (site.Data.docs | default dict) | jsonify }};    // data/docs/versions.(...)
  const LIST_A = Array.isArray(RAW_A) ? RAW_A : (RAW_A?.versions || []);
  const LIST_B = Array.isArray(RAW_B?.versions) ? RAW_B.versions : [];
  const VER_LIST = LIST_A.length ? LIST_A : LIST_B;

  console.debug({
    DEFAULT_VER,
    RAW_A,
    RAW_B,
    LIST_A,
    LIST_B,
    VER_LIST,
  })


  const fromKey = (key) => {
    const [M="0", m="0", p="0"] = String(key || "").split(".");
    return { major: +M || 0, minor: +m || 0, patch: +p || 0 };
  };

  const pickRec = (key) =>
    VER_LIST.find(x => String(x.key) === String(key)) || null;

  const fmt = (v, mode) => {
    const M = +v?.major || 0, m = +v?.minor || 0, p = +v?.patch || 0;
    return mode === "semver" ? `${M}.${m}.${p}` : `${M}.${m}`;
  };

  function updateBindings(vo) {
    const short = fmt(vo, "short");
    const semver = fmt(vo, "semver");

    console.debug({
      short,
      semver,
    });

    document.querySelectorAll('[data-global="docs_version"]').forEach(el => {
      const mode = el.getAttribute("data-format") || "short";
      const out  = fmt(vo, mode);
      const path = (el.getAttribute("data-docs-path") || "").replace(/^\//, "");

      if (el.tagName === "A" && path) {
        const href = `/v${short}/${path}`;
        el.setAttribute("href", href);
        if (!el.hasAttribute("data-no-text")) el.textContent = href;
      } else {
        const attr = el.getAttribute("data-attr");
        if (attr) el.setAttribute(attr, out);
        else el.textContent = out;
      }
    });
  }

  function applyVersion(key, { persist = true } = {}) {
    // Prefer a record; if none, derive directly from the key
    const rec  = pickRec(key);
    const vobj = rec?.docs_version || (rec ? fromKey(rec.key) : fromKey(key));

    // Sync a <select id="version-select"> if present
    const sel = document.getElementById("version-select");

    console.debug('checkpoint 0', {
      rec,
      vobj,
      sel,
      selval: String(sel.value),
      reckey: String(rec?.key),
      key,
    })

    if (sel && String(sel.value) !== String(rec?.key || key)) sel.value = String(rec?.key || key);

    console.debug('checkpoint 2',{
      key,
      rec,
      vobj,
      sel,
    });

    updateBindings(vobj);

    if (persist) {
      if (rec?.key == "undefined" || key == "undefined") return;

      localStorage.setItem("mdai_ver", String(rec?.key || key));
    }

    document.dispatchEvent(new CustomEvent("globalChange", {
      detail: { version: rec || { key }, docs_version: vobj,
                versions: { short: fmt(vobj, "short"), semver: fmt(vobj, "semver") } }
    }));
  }

  // Global setter used by your picker UI
  window.__setVersion = (k) => applyVersion(k);

  function init() {
    const qs = new URLSearchParams(location.search);
    const mdai_ver = localStorage.getItem("mdai_ver") != undefined ? localStorage.getItem("mdai_ver") : undefined;
    const start =
      qs.get("ver") ||
      qs.get("version") ||
      mdai_ver ||
      DEFAULT_VER;

    console.debug('start', {
      start,
      qs_ver: qs.get("ver"),
      qs_version: qs.get("version"),
      ls_mdai_ver: localStorage.getItem("mdai_ver"),
      DEFAULT_VER
    });

    applyVersion(start, { persist: false });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>
