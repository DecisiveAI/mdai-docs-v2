{{- /*
Shortcode: runtime_switcher
Goal: Swap between docs fragments at runtime, rendering ONLY fragment HTML (no site chrome).
Approach: Pre-render each target fragment into <template> tags; JS swaps the chosen one into place on version changes.

Fragment paths like:
  content/docs/1_installation/_fragments/<VERSION>/automated.md
  content/docs/1_installation/_fragments/<VERSION>/manual.md

Runtime version priority:
  1) ?ver= in URL
  2) window.RUNTIME_VER
  3) localStorage["mdai_ver"]
  4) .Site.Params.default_version

Params:
- base   (required): e.g. "docs/1_installation/_fragments"
- keymap (required): JSON mapping selector -> versionDir (e.g. {"0.8.x":"0.8.6","0.9.x":"0.9.2"})
                    (also accepts {"dir":"0.8.6"} objects)
- choose (optional, default "automated"): file inside versionDir ("automated"|"manual"|...)
- inline_fallback (optional, default true): SSR fallback of default fragment
*/ -}}

{{- $base := .Get "base" | default "" -}}
{{- if not $base -}} {{- errorf "runtime_switcher: 'base' param is required" -}} {{- end -}}

{{- $keymapRaw := .Get "keymap" | default "{}" -}}
{{- $choose := .Get "choose" | default "automated" -}}
{{- $inlineFallback := .Get "inline_fallback" | default "true" | lower | eq "true" -}}
{{- $keymap := transform.Unmarshal $keymapRaw -}}

{{- $defaultVer := site.Params.default_version | default "" -}}
{{- $hash := md5 (printf "%s|%s|%s|%s" .Page.RelPermalink $base $choose $defaultVer) -}}
{{- $switchId := printf "rt-switch-%s" (slicestr $hash 0 8) -}}

<div id="{{ $switchId }}" class="runtime-switcher" data-default='{{ $defaultVer }}'>
  {{/* Pre-render one <template> per selector; each contains ONLY fragment HTML via fragment layout */}}
  {{- range $sel, $val := $keymap -}}
    {{- $dir := "" -}}
    {{- if eq (printf "%T" $val) "string" -}} {{- $dir = $val -}}
    {{- else if isset $val "dir" -}} {{- $dir = index $val "dir" -}} {{- end -}}
    {{- if not $dir -}} {{- warnf "runtime_switcher: selector %q has no version dir" $sel -}} {{- continue -}} {{- end -}}
    {{- $p := site.GetPage (printf "/%s/%s/%s" $base $dir $choose) | default (site.GetPage (printf "%s/%s/%s" $base $dir $choose)) -}}
    {{- if not $p -}} {{- warnf "runtime_switcher: page not found for %q at %s/%s/%s" $sel $base $dir $choose -}} {{- continue -}} {{- end -}}
    <template data-key="{{ $sel }}">
      {{- $p.Render "fragment" -}}
    </template>
  {{- end -}}

  <div class="rt-content">
    {{- if $inlineFallback -}}
      {{- $defVal := index $keymap $defaultVer -}}
      {{- $defDir := "" -}}
      {{- if eq (printf "%T" $defVal) "string" -}} {{- $defDir = $defVal -}}
      {{- else if isset $defVal "dir" -}} {{- $defDir = index $defVal "dir" -}} {{- end -}}
      {{- with $defDir -}}
        {{- with (site.GetPage (printf "/%s/%s/%s" $base . $choose) | default (site.GetPage (printf "%s/%s/%s" $base . $choose))) -}}
          {{- .Render "fragment" -}}
        {{- else -}}
          <p><em>Default fragment not found for {{ $defaultVer }}/{{ $choose }}.</em></p>
        {{- end -}}
      {{- else -}}
        <p><em>No default version mapping found.</em></p>
      {{- end -}}
    {{- else -}}
      <p><em>Loadingâ€¦</em></p>
    {{- end -}}
  </div>
</div>

<script>
(function(){
  var root = document.getElementById("{{ $switchId }}");
  if (!root) return;

  var DEF = (root.dataset.default || "").trim();
  var KEY = "mdai_ver";
  var BUS = "mdai:versionchange";

  function norm(v){ return (v == null ? "" : String(v)).trim(); }

  // Resolve desired version: ?ver > window.RUNTIME_VER > localStorage[KEY] > DEF
  function pickVersion(){
    var params = new URLSearchParams(location.search);
    var q = norm(params.get("ver"));
    if (q) return q;
    if (typeof window.RUNTIME_VER === "string" && window.RUNTIME_VER.trim()) return norm(window.RUNTIME_VER);
    try { var ls = localStorage.getItem(KEY); if (ls) return norm(ls); } catch(_) {}
    return norm(DEF);
  }

  function keys(){
    var out = [];
    var tpls = root.querySelectorAll("template[data-key]");
    for (var i=0;i<tpls.length;i++) out.push(tpls[i].dataset.key);
    return out;
  }

  function closestKey(ver, arr){
    if (arr.indexOf(ver) >= 0) return ver;
    var parts = norm(ver).split(".");
    var M = parts[0] || "0", m = parts[1] || "0";
    var cands = [M+"."+m+".x", M+".x"];
    for (var i=0;i<cands.length;i++) if (arr.indexOf(cands[i]) >= 0) return cands[i];
    if (arr.indexOf(DEF) >= 0) return DEF;
    return arr[0] || "";
  }

  function swap(){
    var arr = keys();
    if (!arr.length) return;
    var ver = pickVersion();
    var key = closestKey(ver, arr);
    var tpl = root.querySelector('template[data-key="'+CSS.escape(key)+'"]');
    var slot = root.querySelector(".rt-content");
    if (tpl && slot) slot.innerHTML = tpl.innerHTML;
  }

  // ---- Live update wiring ---------------------------------------------------

  // Global helpers so you can change version in one line
  window.MDAI = window.MDAI || {};
  if (typeof window.MDAI.setVersion !== "function") {
    window.MDAI.setVersion = function(ver, opts){
      opts = opts || {};
      var persist = (opts.persist !== false);
      var setGlobal = (opts.setGlobal !== false);
      var updateUrl = !!opts.updateUrl;

      if (setGlobal) window.RUNTIME_VER = String(ver);
      if (persist) {
        try { localStorage.setItem(KEY, String(ver)); } catch(_) {}
      }
      if (updateUrl) {
        try {
          var u = new URL(location.href);
          u.searchParams.set("ver", String(ver));
          history.replaceState(null, "", u.toString());
        } catch(_) {}
      }
      window.dispatchEvent(new CustomEvent(BUS, {detail:{ver:String(ver)}}));
    };
  }
  if (typeof window.MDAI.refresh !== "function") {
    window.MDAI.refresh = function(){ window.dispatchEvent(new CustomEvent(BUS, {detail:{ver:pickVersion()}})); };
  }

  // React to our custom bus
  window.addEventListener(BUS, swap);

  // React to back/forward or hash changes (URL may carry ?ver=)
  window.addEventListener("popstate", swap);
  window.addEventListener("hashchange", swap);

  // Cross-tab storage events
  window.addEventListener("storage", function(ev){ if (ev && ev.key === KEY) swap(); });

  // Same-tab localStorage changes: monkey-patch setItem/removeItem to emit our event
  try {
    var _setItem = localStorage.setItem, _removeItem = localStorage.removeItem;
    localStorage.setItem = function(k,v){
      _setItem.apply(this, arguments);
      if (k === KEY) window.dispatchEvent(new CustomEvent(BUS, {detail:{ver:String(v)}}));
    };
    localStorage.removeItem = function(k){
      _removeItem.apply(this, arguments);
      if (k === KEY) window.dispatchEvent(new CustomEvent(BUS, {detail:{ver:pickVersion()}}));
    };
  } catch(_) {}

  // Instance-scoped helpers (optional)
  root.runtimeSwitchRefresh = swap;
  root.runtimeSwitchSetVersion = function(ver, opts){ window.MDAI.setVersion(ver, opts); };

  // Initial render
  swap();
})();
</script>
