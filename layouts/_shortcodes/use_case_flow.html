
{{- /* layouts/_shortcodes/use_case_flow.html
     Version-rooted data with per-mode step content.
     Params:
       - usecase (required): e.g., "compliance" (maps to data/use_case/<usecase>.yaml)
       - ver     (required): e.g., "0.9.0"
       - mode    (required): "manual" | "automated"
     Behavior:
       - Renders flow title (if present)
       - For each step: renders step.title
           * If step.modes[mode].sections exists -> render those
           * Else if step.sections exists -> render those
           * Else if step.items exists -> render each item as a header
*/ -}}

{{- $page := .Page -}}

{{- $use := .Get "usecase" -}}
{{- $ver  := .Get "ver" -}}
{{- $mode := lower (.Get "mode") -}}

{{- if not (and $use $ver $mode) -}}
  {{- errorf "use_case_flow: missing param (need usecase, ver, mode)" -}}
{{- end -}}

{{- $all := index site.Data.use_case $use -}}
{{- if not $all -}}
  {{- errorf "use_case_flow: data for %q not found under data/use_case" $use -}}
{{- end -}}

{{- $node := index $all $ver -}}
{{- if not $node -}}
  {{- errorf "use_case_flow: version %q not found for %q" $ver $use -}}
{{- end -}}

{{- $flow := or $node.flow (dict) -}}
{{- $steps := or $flow.steps (slice) -}}

{{- with $flow.title }}

## {{ . }}

{{- end }}

{{- range $steps }}

### {{ .title }}

  {{- /* Resolve sections with per-mode override */ -}}
  {{- $sections := slice -}}
  {{- $hasModes := (and (isset . "modes") (index . "modes")) -}}
  {{- if $hasModes -}}
    {{- $m := index .modes $mode -}}
    {{- if and $m (isset $m "sections") -}}
      {{- $sections = or $m.sections (slice) -}}
    {{- end -}}
  {{- end -}}
  {{- if and (eq (len $sections) 0) (isset . "sections") -}}
    {{- $sections = or .sections (slice) -}}
  {{- end -}}

  {{- if gt (len $sections) 0 }}
    {{- range $sections }}

#### {{ .heading }}

{{ with .body }}
  {{- $s := trim . "\n" -}}
  {{- $out := $page.RenderString (dict "display" "block") $s -}}
  {{- $out | safeHTML -}}
{{ end }}

{{- with .code }}

```{{ .lang | default "bash" }}
{{ .text -}}
```
      {{- end -}}
    {{- end -}}
  {{- else }}
    {{- with .items }}
      {{- range . }}
#### {{ . }}
      {{- end -}}
    {{- end -}}
  {{- end }}
{{- end }}
