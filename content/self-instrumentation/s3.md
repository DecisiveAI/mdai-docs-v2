+++
title = 'Via S3'
url = '/self-instrumentation/'
sectionPagesMenu = "MDAI Self-monitoring"
weight = 1
+++


# MDAI Self-Monitoring with AWS S3

## Steps involved

1. Create and obtain AWS IAM User with a long-term access key

1. Set up an IAM Policy to enable S3 permissions

1. Generate a secret using the long-term credentials

1. The `mdai-collector` references the secret to enable the e2e connectivity for MDAI to access the specified s3 bucket.


>[!INFO]
>
>This guide assumes you have
>1. Cloned our [`mdai-labs` repo](https://github.com/DecisiveAI/mdai-labs/tree/main) set this as your working directory
>2. Have access to an AWS account with Admin Admin access

### Step 1: Create a user via IAM

For our quickstart example, we will use a [non-federated user in AWS IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/getting-started-workloads.html) that has long-term credentials. You do not need console access for this user.

#### Set Permissions: Attach inline policies

Using our [`./mdai/self_monitoring/s3-policy.json` file](https://github.com/DecisiveAI/mdai-labs/blob/main/mdai/self_monitoring/s3-policy.json), you should be able to _Attach policies directly_ to the user. Don't forget to update the policy to point to your bucket.

#### Create an Access Key for the user

For this example, we can choose _Local Code_ or _Other_. You will likely be [recommended to use an IDE](https://aws.amazon.com/developer/tools/#IDE_and_IDE_Toolkits) for access management or warned of the risks of using long-term credentials with a non-federated user. Please do not dismiss these risks.

>[!NOTE]
>
> 🛑 **Warning**
>
> We do not recommend using this setup for a development or greater environment -- this is truly for the quickstart. If you're in AW EKS, we recommend [IRSA](https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html) for a similar effect.
>
>
> ⚠️ **Important**
>
> When you create the access key, you will need to download the file or make note of the `Access key ID` and the `Secret access key`.

### Step 2: Apply secret via long-term access key

Now you will programatically update the `.env` file to use your long-term access keys

##### Create / Use `.env` file to store Access Keys

If you don't already, create a `.env` file. Then, update the `.env` file to have your credentials. It should look similar to the following:

```
AWS_ACCESS_KEY_ID="50M3R@ND0M@CC355K3Y"
AWS_SECRET_ACCESS_KEY="50M3R@ND0M53CR3T@CC355K3Y"
```

##### Ensure MDAI script executable

Make sure to run the following so the shell script is executable.

```
chmod +x ./mdai/self_monitoring/aws_secret_from_env.sh
```


##### Run script to create secret

Execute the shell script to generate and map new long-term aws credentials as a secret to your cluster

```
./mdai/self_monitoring/aws_secret_from_env.sh
```

After running this, you will have a secret created inside of your cluster.

##### Deploy the MDAI Collector to your cluster**

```sh
kubectl apply -f ./mdai/hub_monitor/mdai_monitor.yaml
```
<br />


>[!NOTE]
>
>To stop logs from sending to s3, you will need to delete the MdaiCollector Custom Resource


### Step 3: Deploy hub

If you haven't already installed the `mdai-hub` in your cluster, you can now do so using the following command.
 ```
 helm upgrade --install mdai mdai-hub \
  --repo https://charts.mydecisive.ai \
  --namespace mdai \
  --create-namespace \
  --version v0.8.0-rc3 \
  --cleanup-on-fail >/dev/null 2>&1 || echo "⚠️ mdai: unable to install helm chart"
 ```

---

## Other important details

>[!INFO]
>
> Related to monitor config, `mdai/hub_monitor/mdai_monitor.yaml`
>
> The name (`hub-monitor`) must correspond to the beginning of the host name in your helm install script.
>
>`values.yaml` for the [operator](https://github.com/DecisiveAI/mdai-hub/blob/422e1c345806f634ed92db2a67a672ed7e9c7101/values.yaml#L52) and [mdai-gateway](https://github.com/DecisiveAI/mdai-hub/blob/422e1c345806f634ed92db2a67a672ed7e9c7101/values.yaml#L59). So if the MdaiCollector resource name is `hub-monitor`, the corresponding service endpoint created is `http://hub-monitor-mdai-collector-service.mdai.svc.cluster.local:4318`.
>
>If they are not matching, you can re-deploy using the `--set` command when running helm install.
>
>
>
> ⚠️ **Important**
>
> To stop logs from sending to s3, you will need to delete the MdaiCollector Custom Resource



